name: ci

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        python-version: [3.6, 3.7, 3.8, 3.9]
        engine: [docker, singularity, podman]
    steps:
    - uses: actions/checkout@v2

    - name: set env variables
      run: |
        echo "::set-env name=PYTHON_VERSION::${{ matrix.python-version }}"
        echo "::set-env name=ENGINE::${{ matrix.engine }}"
        if [[ "${{ matrix.engine }}" == "docker" ]]; then
          echo "::set-env name=ENABLE_SLURM_RUNNER_TESTS::1"
          echo "::set-env name=ENABLE_K8S_RUNNER_TESTS::1"
        fi

    - name: set up python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: install
      run: |
        python -m pip install --upgrade pip
        pip install coverage
        pip install -e src/[dev]

    - name: lint
      run: black --check --diff .

    - name: test
      run: |
        # run tests
        coverage run -m unittest src/test/test_*

    - name: package
      run: |
        # obtain version (generate src/popper/_version.py)
        popper version
        # run release pipeline
        popper run --allow-undefined-secrets-in-ci

    - name: upload coverage results
      run: bash <(curl -s https://codecov.io/bash)
