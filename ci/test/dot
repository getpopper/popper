#!/bin/bash
set -ex

source ./common
init_test_repo
cd $test_repo_path

## testing default file feature
git clone https://github.com/cplee/github-actions-demo.git
cd github-actions-demo

export PHONY_SECRET=foo

popper dot > dot_output

cat dot_output | grep "digraph G"
cat dot_output | grep "branch_filter -> deploy;"
cat dot_output | grep "install -> lint;"
cat dot_output | grep "install -> test;"
cat dot_output | grep "lint -> branch_filter;"
cat dot_output | grep "test_and_deploy -> install;"
cat dot_output | grep "test -> branch_filter;"

cd $test_repo_path
git clone https://github.com/actions/example-aws.git
cd example-aws/

export KUBE_CONFIG_DATA=foo
export AWS_ACCESS_KEY_ID=foo
export AWS_SECRET_ACCESS_KEY=foo

## Testing --recursive feature
# Move main.workflow to somewhere else to test --recursive flag
mkdir dummy
mv .github/main.workflow dummy/.
popper dot --recursive > dot_output

cat dot_output | grep "digraph G"
cat dot_output | grep "Build_and_Deploy -> Build_Docker_image;"
cat dot_output | grep "Build_and_Deploy -> Login_to_ECR;"
cat dot_output | grep "Build_Docker_image -> Tag_image_for_ECR;"
cat dot_output | grep "Deploy_branch_filter -> Deploy_to_EKS;"
cat dot_output | grep "Deploy_to_EKS -> Verify_EKS_deployment;"
cat dot_output | grep "Login_to_ECR -> Push_image_to_ECR;"
cat dot_output | grep "Push_image_to_ECR -> Deploy_branch_filter;"
cat dot_output | grep "Push_image_to_ECR -> Store_Kube_Credentials;"
cat dot_output | grep "Push_image_to_ECR -> Verify_EKS_deployment;"
cat dot_output | grep "Store_Kube_Credentials -> Deploy_to_EKS;"
cat dot_output | grep "Tag_image_for_ECR -> Push_image_to_ECR;"
cat dot_output | grep "Verify_EKS_deployment -> List_Public_IP;"


## testing --wfile feature
cd $test_repo_path
popper dot --wfile example-aws/dummy/main.workflow > dot_output

cat dot_output | grep "digraph G"
cat dot_output | grep "Build_and_Deploy -> Build_Docker_image;"
cat dot_output | grep "Build_and_Deploy -> Login_to_ECR;"
cat dot_output | grep "Build_Docker_image -> Tag_image_for_ECR;"
cat dot_output | grep "Deploy_branch_filter -> Deploy_to_EKS;"
cat dot_output | grep "Deploy_to_EKS -> Verify_EKS_deployment;"
cat dot_output | grep "Login_to_ECR -> Push_image_to_ECR;"
cat dot_output | grep "Push_image_to_ECR -> Deploy_branch_filter;"
cat dot_output | grep "Push_image_to_ECR -> Store_Kube_Credentials;"
cat dot_output | grep "Push_image_to_ECR -> Verify_EKS_deployment;"
cat dot_output | grep "Store_Kube_Credentials -> Deploy_to_EKS;"
cat dot_output | grep "Tag_image_for_ECR -> Push_image_to_ECR;"
