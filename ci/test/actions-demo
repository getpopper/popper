#!/bin/bash
set -ex

source ./common

delete_dir /tmp/gha-demo
git clone https://github.com/cplee/github-actions-demo /tmp/gha-demo
pushd /tmp/gha-demo
PHONY_SECRET=phony popper run --debug
popd

# test with an action defined on the root of the repo
delete_dir /tmp/npm
git clone https://github.com/actions/npm /tmp/npm
pushd /tmp/npm
DOCKER_USERNAME=foo DOCKER_PASSWORD=bar popper run "Integration Test"
popd

# test with actions hosted on gitlab
init_test_repo
cd $test_repo_path
cat <<EOF > main.workflow
workflow "clone" {
  resolves = "test clone git@"
}

action "test clone https" {
  uses = "https://gitlab.com/barbaragd/action-test.git@master"
}

action "test clone git@"{
  uses = "git@gitlab.com:barbaragd/action-test.git@master"
  needs = "test clone https"
}
EOF

popper run
